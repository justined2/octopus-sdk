const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sockjs-CYgfAnXb.js","assets/index.js","assets/index.css"])))=>i.map(i=>d[i]);
import{S as D,J as N,v as M,K as W,U as B,p as w,D as _,L as l,V as U,l as L}from"./index.js";var I={exports:{}};(function(e,t){(function(s,n){e.exports=n()})(D,function(){return function(s,n,o){s=s||{};var r=n.prototype,k={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function S(i,c,u,f){return r.fromToBase(i,c,u,f)}o.en.relativeTime=k,r.fromToBase=function(i,c,u,f,A){for(var b,d,p,g=u.$locale().relativeTime||k,v=s.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],R=v.length,h=0;h<R;h+=1){var m=v[h];m.d&&(b=f?o(i).diff(u,m.d,!0):u.diff(i,m.d,!0));var a=(s.rounding||Math.round)(Math.abs(b));if(p=b>0,a<=m.r||!m.r){a<=1&&h>0&&(m=v[h-1]);var C=g[m.l];A&&(a=A(""+a)),d=typeof C=="string"?C.replace("%d",a):C(a,c,m.l,p);break}}if(c)return d;var E=p?g.future:g.past;return typeof E=="function"?E(d):E.replace("%s",d)},r.to=function(i,c){return S(i,c,this,!0)},r.from=function(i,c){return S(i,c,this)};var T=function(i){return i.$u?o.utc():o()};r.toNow=function(i){return this.to(T(this),i)},r.fromNow=function(i){return this.from(T(this),i)}}})})(I);var F=I.exports;const H=N(F),q={trimChar(e,t){for(;e.startsWith(t);)e=e.substring(1);for(;e.endsWith(t);)e=e.substring(0,e.length-1);return e}};let y=null,P=null;class x{url;endpoint;subscriptions;socket;client;queuedMessages;processingMsg;wssBroken;constructor(t,s){this.url=t,this.endpoint=s,this.subscriptions=[],this.processingMsg=!1,this.queuedMessages=[],this.wssBroken=!1}async processQueuedMessages(){if(!this.processingMsg&&this.queuedMessages.length!==0){this.processingMsg=!0;try{const t=this.queuedMessages.shift();await t.callback(t.message)}catch(t){console.log(t)}this.processingMsg=!1,this.processQueuedMessages()}}async connect(){return new Promise((t,s)=>{(async()=>(y===null&&await M(()=>import("./sockjs-CYgfAnXb.js").then(n=>n.s),__vite__mapDeps([0,1,2])).then(n=>{y=n.default}),P===null&&await M(()=>import("./index-D-env2Ga.js"),[]).then(n=>{P=n.Stomp}),this.socket=new y("https://"+this.url+"/"+this.endpoint),this.client=P.over(this.socket),this.client.heartbeat.outgoing=2e3,this.client.heartbeat.incoming=2e3,this.client.debug=n=>{n.includes("did not receive server activity for the last")&&(this.wssBroken=!0)},this.client.onConnect=()=>{this.connectionSuccess(),t()},this.client.onStompError=()=>{this.wssBroken=!0,this.connectionErrorReconnect(),s(new Error)},this.client.onWebSocketError=()=>{this.wssBroken=!0,this.connectionErrorReconnect(),s(new Error)},this.client.onDisconnect=()=>{this.connectionErrorReconnect(),s(new Error)},this.client.onWebSocketClose=()=>{this.connectionErrorReconnect(),s(new Error)},this.client.activate()))()})}async connectionErrorReconnect(){this.wssBroken&&(console.log("Error in ws try to reconnect"),setTimeout(()=>{this.connect()},10),this.wssBroken=!1)}connectionSuccess(){this.subscriptions.forEach(t=>{try{this.subscribe(t.topic,t.callback)}catch{setTimeout(()=>{this.connect()},1e4);return}})}subscribe(t,s){const n=this.client.subscribe(t,o=>{this.queuedMessages.push({message:o,callback:s}),this.processQueuedMessages()});this.subscriptions.push({id:n.id,topic:t,callback:s})}unsubscribe(t){if(!t)throw new Error("Cannot remove subscription if no search pattern is founded");const s=[];this.subscriptions.forEach(n=>{let o=!0;if(n.topic!==t&&(o=!1),o){s.push(n);try{this.client.unsubscribe(n.id)}catch{console.log("Error while deconnecting client with item "+n.id)}}}),this.subscriptions=this.subscriptions.filter(n=>!s.includes(n))}disconnect(){this.client.deactivate()}}class Q{uri;connection;subscribedEventComment;constructor(t){this.uri=t,this.connection=void 0,this.subscribedEventComment=void 0}async initialize(){this.connection=new x(this.uri,"websocket"),await this.connection.connect()}async close(){this.connection&&(this.connection.disconnect(),this.connection=void 0)}subscribeToPodcastCommentEventBus(t,s,n){if(!this.connection)throw new Error("Websocket engine must be initialized, before it can subscribe to any events");t&&(this.connection.subscribe(s,o=>{const r=JSON.parse(o.body);n.call(this,r)}),this.subscribedEventComment=t)}unsubscribeToPodcastCommentEventBus(t,s){if(!this.connection)throw new Error("Websocket engine must be initialized, before it can unsubscribe to any events");if(!t)throw new Error("Cannot unsubscribe to comments event bus if no id provided");this.connection.unsubscribe(s),this.subscribedEventComment=void 0}isPodcastCommentEventConnected(t){return t===this.subscribedEventComment}}W.extend(H);const O=B("CommentStore",{state:()=>({commentInitialized:!1,commentWebsocketengine:void 0,commentPodcastId:void 0,commentQueueName:void 0,commentEventToHandle:[],commentsForPlayer:{},podcastsCommentsConfig:{}}),actions:{async fetchCommentsForPlayer(e){if(!this.commentsForPlayer[e]){this.commentsForPlayer[e]=[];const t=50;let s=0,n=!0;for(;n;){const o=await w.fetchData({api:2,path:"comment/list",parameters:{first:s,size:t,podcastId:e,sort:"DATE_DESC",hideAnswers:!0,state:"VALIDATED"},isNotAuth:!0});s+=t,this.commentsForPlayer[e]=this.commentsForPlayer[e].concat(o.result),n=o.count!==this.commentsForPlayer[e].length}}return this.commentsForPlayer[e]},async digest(e){return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",new TextEncoder().encode(e))),t=>t.toString(16).padStart(2,"0")).join("")},async initCommentUser(){if(this.commentUser)return;const e=_();if(e.authProfile){this.commentUser={name:e.authName,uuid:e.authProfile.userId};return}let t=l.methods.getCookie("comment-octopus-uuid");t===null&&(t=U.uuidv4(),l.methods.setCookie("comment-octopus-uuid",t));const s=await this.digest(t);this.commentUser={name:l.methods.getCookie("comment-octopus-name"),uuid:t,uuidHash:s}},setCommentUser(e){_().authProfile||!this.commentUser||(l.methods.setCookie("comment-octopus-name",e),this.commentUser.name=e)},async getCommentsConfig(e){if(this.podcastsCommentsConfig[e.podcastId])return this.podcastsCommentsConfig[e.podcastId];try{this.podcastsCommentsConfig[e.podcastId]=await w.fetchData({api:2,path:"config/podcast/"+e.podcastId})}catch{this.podcastsCommentsConfig[e.podcastId]=await w.fetchData({api:2,path:"config/emission/"+e.emission.emissionId})}return this.podcastsCommentsConfig[e.podcastId]},resetPodcastsConfig(){this.podcastsCommentsConfig={}},updatePodcastsConfig(e,t){this.podcastsCommentsConfig[e]=t},getCanPostCommentAllowed(e,t){if(e.comments.commentAllowed==="NONE")return!1;const s=e.comments.commentAllowed==="LIVE_ONLY"&&t.conferenceId!==void 0&&t.processingStatus==="READY_TO_RECORD",n=e.comments.commentAllowed==="LIVE_AND_REPLAY"&&t.conferenceId!==void 0;return e.comments.commentAllowed==="ALL"||s||n},getCanPostComment(e,t,s){return!e||!t?!1:this.getCanPostCommentAllowed(e,t)&&(!e.comments.authRequired||e.comments.authRequired&&s)},getCanReportAbuse(e,t){return e?!e.abuse.authRequired||e.abuse.authRequired&&t:!1},async initialize(){const t=L().commentUrl??"https://comments.dev2.saooti.org/",s=q.trimChar(t.replace("https://",""),"/"),n=new Q(s);await n.initialize(),this.commentWebsocketengine=n,this.commentInitialized=!0},unsubscribeToEvent(){this.commentWebsocketengine&&this.commentPodcastId&&this.commentQueueName&&this.commentWebsocketengine.isPodcastCommentEventConnected(this.commentPodcastId)&&this.commentWebsocketengine.unsubscribeToPodcastCommentEventBus(this.commentPodcastId,this.commentQueueName)},subscribeToEvents(){this.commentWebsocketengine&&this.commentPodcastId&&this.commentQueueName&&this.commentWebsocketengine.subscribeToPodcastCommentEventBus(this.commentPodcastId,this.commentQueueName,e=>{this.commentEventToHandleUpdate(e)})},async initComments(e,t){this.unsubscribeToEvent(),this.commentQueueName="/topic/comment."+t+"."+e,this.commentPodcastId=e,this.subscribeToEvents()},async unsubscribeComments(){this.unsubscribeComments(),this.commentPodcastId=void 0},commentEventHandled(){this.commentEventToHandle.shift()},commentEventToHandleUpdate(e){e?this.commentEventToHandle.push(e):this.commentEventToHandle.splice(0,this.commentEventToHandle.length)}}});export{H as r,O as u};
